
#!/usr/bin/env node

// GitHub Pages deployment script
const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');
const https = require('https');

// Colors for console output
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  green: '\x1b[32m',
  blue: '\x1b[34m',
  yellow: '\x1b[33m',
  red: '\x1b[31m',
  cyan: '\x1b[36m'
};

console.log(`${colors.cyan}${colors.bright}ü¶ñ DinoTradez GitHub Pages Deployment${colors.reset}`);
console.log(`${colors.cyan}=====================================${colors.reset}\n`);

try {
  // Build the project with production settings
  console.log(`${colors.blue}üì¶ Building project...${colors.reset}`);
  execSync('npm run build', { stdio: 'inherit', env: { ...process.env, NODE_ENV: 'production' } });
  console.log(`${colors.green}‚úÖ Build completed successfully!${colors.reset}`);

  // Verify the build output exists
  const distPath = path.join(__dirname, 'dist');
  if (!fs.existsSync(distPath)) {
    throw new Error('dist directory not found! Build may have failed silently.');
  }

  const indexPath = path.join(distPath, 'index.html');
  if (!fs.existsSync(indexPath)) {
    throw new Error('index.html not found in dist folder! Build output is incomplete.');
  }

  // Create .nojekyll file (needed for GitHub Pages)
  console.log(`\n${colors.blue}üìÑ Creating .nojekyll file...${colors.reset}`);
  fs.writeFileSync(path.join(distPath, '.nojekyll'), '');
  console.log(`${colors.green}‚úÖ .nojekyll file created!${colors.reset}`);

  // Create 404.html for SPA routing
  console.log(`\n${colors.blue}üìÑ Creating 404.html file...${colors.reset}`);
  fs.copyFileSync(indexPath, path.join(distPath, '404.html'));
  console.log(`${colors.green}‚úÖ 404.html file created!${colors.reset}`);

  // Add cache busting timestamp
  const timestamp = Date.now();
  console.log(`\n${colors.blue}üîÑ Adding cache busting timestamp...${colors.reset}`);
  const indexContent = fs.readFileSync(indexPath, 'utf8');
  const updatedIndexContent = indexContent.replace('</head>', 
    `<meta name="build-timestamp" content="${timestamp}" />\n</head>`);
  fs.writeFileSync(indexPath, updatedIndexContent);
  console.log(`${colors.green}‚úÖ Cache busting timestamp added!${colors.reset}`);

  // Create a deployment timestamp file
  console.log(`\n${colors.blue}üìÑ Creating deployment timestamp file...${colors.reset}`);
  fs.writeFileSync(path.join(distPath, 'deploy-timestamp.txt'), `Deployed on: ${new Date().toISOString()} with timestamp: ${timestamp}`);
  console.log(`${colors.green}‚úÖ Timestamp file created!${colors.reset}`);

  // Create a deployment status page
  console.log(`\n${colors.blue}üìÑ Creating deployment status page...${colors.reset}`);
  const statusPage = `
<!DOCTYPE html>
<html>
<head>
  <title>DinoTradez Deployment Status</title>
  <meta name="deployment-id" content="${timestamp}">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    body {
      background-color: #000000;
      color: #ffffff;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .status {
      background-color: #0f172a;
      border-radius: 8px;
      padding: 20px;
      margin: 20px auto;
      max-width: 600px;
    }
    .timestamp {
      color: #3b82f6;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ü¶ñ DinoTradez Deployment Status</h1>
  <div class="status">
    <h2>Deployment Active</h2>
    <p>This page confirms that your deployment is active.</p>
    <p>Deployment Timestamp: <span class="timestamp">${timestamp}</span></p>
    <p>Deployment Time: <span class="timestamp">${new Date().toISOString()}</span></p>
    <p><a href="./" style="color: #3b82f6;">Return to DinoTradez App</a></p>
  </div>
</body>
</html>
  `;
  fs.writeFileSync(path.join(distPath, 'deployment-status.html'), statusPage);
  console.log(`${colors.green}‚úÖ Deployment status page created!${colors.reset}`);

  // Deploy to GitHub Pages
  console.log(`\n${colors.blue}üöÄ Deploying to GitHub Pages...${colors.reset}`);
  console.log(`${colors.yellow}This may take a few minutes...${colors.reset}`);
  execSync('npx gh-pages -d dist --no-history', { stdio: 'inherit' });
  console.log(`${colors.green}‚úÖ Deployment submitted successfully!${colors.reset}`);

  console.log(`\n${colors.cyan}${colors.bright}Deployment Information:${colors.reset}`);
  console.log(`${colors.yellow}‚Ä¢ Deployment timestamp: ${timestamp}${colors.reset}`);
  console.log(`${colors.yellow}‚Ä¢ Your site should be available at:${colors.reset}`);
  console.log(`  ${colors.bright}https://jjsppl.github.io/dinotradez/${colors.reset}`);
  
  console.log(`\n${colors.yellow}‚ö†Ô∏è Important Notes:${colors.reset}`);
  console.log(`${colors.yellow}‚Ä¢ GitHub Pages deployment typically takes 1-5 minutes to process${colors.reset}`);
  console.log(`${colors.yellow}‚Ä¢ You can check deployment status in the GitHub repository's Actions tab${colors.reset}`);
  console.log(`${colors.yellow}‚Ä¢ To verify the deployment, wait a few minutes and then visit:${colors.reset}`);
  console.log(`  ${colors.bright}https://jjsppl.github.io/dinotradez/deployment-status.html${colors.reset}`);
  console.log(`  If you see the timestamp "${timestamp}", your deployment is live${colors.reset}`);
  
  // Provide a function to check deployment status
  console.log(`\n${colors.blue}Checking deployment status...${colors.reset}`);
  console.log(`${colors.yellow}Will check again in 60 seconds...${colors.reset}`);
  
  // Set a timeout to check the deployment after 60 seconds
  setTimeout(() => {
    checkDeploymentStatus('https://jjsppl.github.io/dinotradez/deploy-timestamp.txt', timestamp);
  }, 60000);

} catch (error) {
  console.error(`\n${colors.red}‚ùå Error during deployment:${colors.reset}`, error);
  process.exit(1);
}

// Function to check if deployment is live
function checkDeploymentStatus(url, expectedTimestamp) {
  https.get(url, (res) => {
    let data = '';
    
    res.on('data', (chunk) => {
      data += chunk;
    });
    
    res.on('end', () => {
      if (data.includes(expectedTimestamp.toString())) {
        console.log(`\n${colors.green}‚úÖ Deployment confirmed live!${colors.reset}`);
        console.log(`${colors.green}Your site is now available at:${colors.reset}`);
        console.log(`${colors.bright}https://jjsppl.github.io/dinotradez/${colors.reset}`);
      } else {
        console.log(`\n${colors.yellow}‚ö†Ô∏è Deployment not yet detected or cache not updated.${colors.reset}`);
        console.log(`${colors.yellow}This is normal - GitHub Pages deployments can take up to 10 minutes.${colors.reset}`);
        console.log(`${colors.yellow}Try visiting your site in incognito mode or after clearing cache:${colors.reset}`);
        console.log(`${colors.bright}https://jjsppl.github.io/dinotradez/${colors.reset}`);
        console.log(`${colors.bright}https://jjsppl.github.io/dinotradez/?t=${Date.now()}${colors.reset}`);
      }
    });
  }).on('error', (err) => {
    console.log(`\n${colors.yellow}‚ö†Ô∏è Could not verify deployment:${colors.reset}`, err.message);
    console.log(`${colors.yellow}GitHub Pages may still be processing your deployment.${colors.reset}`);
    console.log(`${colors.yellow}Check again in a few minutes at:${colors.reset}`);
    console.log(`${colors.bright}https://jjsppl.github.io/dinotradez/${colors.reset}`);
  });
}
