
name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: Debug build output
        run: |
          echo "Listing dist directory contents:"
          ls -la dist/
          echo "Checking for index.html:"
          cat dist/index.html | head -20
          echo "Checking asset paths:"
          grep -r "src=" dist/index.html || echo "No src attributes found"
          grep -r "href=" dist/index.html || echo "No href attributes found"

      - name: Setup GitHub Pages files
        run: |
          # Create .nojekyll file to disable Jekyll processing
          touch dist/.nojekyll
          
          # Create 404.html for SPA routing
          cp dist/index.html dist/404.html
          
          # Add timestamp for cache busting
          TIMESTAMP=$(date +%s)
          echo "<meta name=\"build-timestamp\" content=\"$TIMESTAMP\">" >> dist/index.html
          
          # Create timestamp file to verify deployment
          echo "Deployed on: $(date -u) with timestamp: $TIMESTAMP" > dist/deploy-timestamp.txt
          
          # Create cache control headers
          cat > dist/_headers <<EOL
          /*
            Cache-Control: no-cache, no-store, must-revalidate
          /assets/*
            Cache-Control: public, max-age=31536000, immutable
          EOL
          
          # Create a test HTML file to confirm deployment
          cat > dist/deployment-status.html <<EOL
          <!DOCTYPE html>
          <html>
          <head>
            <title>DinoTradez Deployment Status</title>
            <meta name="deployment-id" content="$TIMESTAMP">
            <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
            <meta http-equiv="Pragma" content="no-cache" />
            <meta http-equiv="Expires" content="0" />
            <style>
              body {
                background-color: #000000;
                color: #ffffff;
                font-family: 'Inter', sans-serif;
                margin: 0;
                padding: 20px;
                text-align: center;
              }
              .status {
                background-color: #0f172a;
                border-radius: 8px;
                padding: 20px;
                margin: 20px auto;
                max-width: 600px;
              }
              .timestamp {
                color: #3b82f6;
                font-weight: bold;
              }
            </style>
          </head>
          <body>
            <h1>ðŸ¦– DinoTradez Deployment Status</h1>
            <div class="status">
              <h2>Deployment Active</h2>
              <p>This page confirms that your deployment is active.</p>
              <p>Deployment Timestamp: <span class="timestamp">$TIMESTAMP</span></p>
              <p>Deployment Time: <span class="timestamp">$(date -u)</span></p>
              <p><a href="./" style="color: #3b82f6;">Return to DinoTradez App</a></p>
            </div>
          </body>
          </html>
          EOL
          
          echo "Created deployment status page with timestamp: $TIMESTAMP"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          force_orphan: true
          cname: ${{ secrets.CNAME }}
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy to GitHub Pages [skip ci]'

      - name: Clear GitHub Pages cache
        run: |
          # Using the GitHub API to request a new build
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pages/builds

      - name: Deployment Summary
        run: |
          TIMESTAMP=$(date +%s)
          echo "## ðŸ¦– DinoTradez Deployment" >> $GITHUB_STEP_SUMMARY
          echo "Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Timestamp:** ${TIMESTAMP}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Important Notes" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Pages may take a few minutes to reflect changes" >> $GITHUB_STEP_SUMMARY
          echo "- Site URL: https://jjsppl.github.io/dinotradez/" >> $GITHUB_STEP_SUMMARY
          echo "- Verify deployment at https://jjsppl.github.io/dinotradez/deployment-status.html" >> $GITHUB_STEP_SUMMARY
          echo "- Check timestamp file at https://jjsppl.github.io/dinotradez/deploy-timestamp.txt" >> $GITHUB_STEP_SUMMARY
