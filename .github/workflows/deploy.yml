
name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: Debug build output
        run: |
          echo "Listing dist directory contents:"
          ls -la dist/
          echo "Checking for index.html:"
          cat dist/index.html | head -20
          echo "Checking asset paths:"
          grep -r "src=" dist/index.html || echo "No src attributes found"
          grep -r "href=" dist/index.html || echo "No href attributes found"

      - name: Setup GitHub Pages files
        run: |
          # Create .nojekyll file to disable Jekyll processing
          touch dist/.nojekyll
          
          # Create 404.html for SPA routing
          cp dist/index.html dist/404.html
          
          # Create a test HTML file to confirm deployment
          cat > dist/test.html <<EOL
          <!DOCTYPE html>
          <html>
          <head>
            <title>DinoTradez Test Page</title>
            <style>
              body {
                background-color: #000000;
                color: #ffffff;
                font-family: 'Inter', sans-serif;
                margin: 0;
                padding: 20px;
                text-align: center;
              }
            </style>
          </head>
          <body>
            <h1>DinoTradez Test Page</h1>
            <p>If you can see this, deployment was successful.</p>
            <p>Timestamp: $(date)</p>
            <p><a href="./" style="color: #3b82f6;">Go to main app</a></p>
          </body>
          </html>
          EOL

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          force_orphan: true
