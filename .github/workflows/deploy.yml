
name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          NODE_ENV: production
          BASE_URL: "./"
          
      - name: Debug build output
        run: |
          echo "Listing dist directory contents:"
          ls -la dist/
          echo "Checking for index.html:"
          cat dist/index.html | head -20
          echo "Checking asset paths:"
          grep -r "src=" dist/index.html || echo "No src attributes found"
          grep -r "href=" dist/index.html || echo "No href attributes found"

      - name: Setup GitHub Pages files
        run: |
          # Create .nojekyll file to disable Jekyll processing
          touch dist/.nojekyll
          
          # Create 404.html for SPA routing (exact copy of index.html)
          cp dist/index.html dist/404.html
          
          # Create proper content type headers
          cat > dist/_headers <<EOL
          /*
            Content-Type: text/html; charset=utf-8
          /*.js
            Content-Type: application/javascript
          /*.css
            Content-Type: text/css
          /*.json
            Content-Type: application/json
          EOL
          
          # Create a temporary HTML file to test direct access
          cat > dist/test.html <<EOL
          <!DOCTYPE html>
          <html>
          <head>
            <title>Test Page</title>
          </head>
          <body style="background-color:#ffffff;color:#000000;">
            <h1>Test Page</h1>
            <p>If you can see this, static file serving is working correctly.</p>
            <p>Timestamp: $(date)</p>
          </body>
          </html>
          EOL

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          force_orphan: true
